<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="apple-touch-icon" href="siteicon.png">
    <link rel="icon" href="siteicon.png" sizes="180x180" type="image/png">
    <title>COVID-19: how's your area doing?</title>
    <meta property="og:title" content="COVID-19: how's your area doing?">
    <meta property="og:description"
          content="Use the GOV.UK data to see how long since your area had a confirmed case. Compare with historical data to see how it's doing over time.">
    <meta property="og:image" content="https://hjst.github.io/covid-streak/share-image-streak.png">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@hjst">
    <link rel="stylesheet" href="main.css"/>
    <script lang="JavaScript">
        const params = new URLSearchParams(window.location.search);
        const areaType = "utla";
        const areaCode = (params.get("area"));
        const responseStructure = {
            "date": "date",
            "areaName": "areaName",
            "newCases": "newCasesBySpecimenDate"
        };
        const query_url = `https://api.coronavirus.data.gov.uk/v1/data`
            + `?filters=areaType=${areaType};areaCode=${areaCode}`
            + `&structure=${JSON.stringify(responseStructure)}`;

        function days_diff(start, finish) {
            return Math.floor((finish - start) / 1000 / 60 / 60 / 24);
        }

        function count_days_since(days) {
            // Assumes array comes in reverse date order, most recent day first
            const now = new Date();
            let last_known_case = days.find(day => day.newCases > 0);
            if (!last_known_case) {
                last_known_case = days[days.length - 1]; // earliest known day
                // TODO: better handling of no known cases
                return `${days_diff(new Date(last_known_case.date), now)}+`;
            }
            return days_diff(new Date(last_known_case.date), now);
        }

        function get_date_span_html(start, finish) {
            const startDay = start.getDate();
            const finishDay = finish.getDate();
            if (start.getMonth() === finish.getMonth()) {
                const month = new Intl.DateTimeFormat('default', {month: 'long'});
                return `${startDay}<sup>${ordinal_suffix(startDay)}</sup> to `
                    + `${finishDay}<sup>${ordinal_suffix(finishDay)}</sup> ${month.format(start)}`;
            } else {
                const month = new Intl.DateTimeFormat('default', {month: 'short'});
                return `${startDay}<sup>${ordinal_suffix(startDay)}</sup> ${month.format(start)} to `
                    + `${finishDay}<sup>${ordinal_suffix(finishDay)}</sup> ${month.format(finish)}`;
            }
        }

        function ordinal_suffix(dayNum) {
            // https://v8.dev/features/intl-pluralrules
            const pr = new Intl.PluralRules('default', {
                type: 'ordinal'
            });
            const suffixes = new Map([
                ['one', 'st'],
                ['two', 'nd'],
                ['few', 'rd'],
                ['other', 'th'],
            ]);
            return suffixes.get(pr.select(dayNum));
        }

        function tidy_name(name) {
            return name.replace(/, (City|County) of/g, '');
        }

        function find_streaks(days) {
            const streaks = [];
            let num_streaks = 0;
            let streak_active = false;
            days.forEach((day) => {
                if (streak_active === false && day.newCases === 0) {
                    // new streak!
                    streak_active = true;
                    streaks[num_streaks] = {
                        numDays: 1,
                        start: day.date
                    };
                } else if (streak_active === true && day.newCases === 0) {
                    // streak continues!
                    streaks[num_streaks].numDays += 1;
                } else if (streak_active === true && day.newCases > 0) {
                    // streak finishes!
                    streaks[num_streaks].finish = day.date;
                    streak_active = false;
                    num_streaks += 1;
                } else {
                    // non-streak days, do nothing
                }
            });
            return streaks;
        }

        function get_history_visual(days) {
            const most_recent_day = days[0].date;
            const missing_days = days_diff(new Date(most_recent_day), new Date());
            for (let index = 1; index <= missing_days; index++) {
                const missing_day = {};
                if (index === missing_days) {
                    missing_day.date = "Today";
                } else {
                    const missing_date = new Date(most_recent_day);
                    missing_date.setDate(missing_date.getDate() + index);
                    missing_day.date = missing_date.toISOString().split('T')[0];
                }
                days.unshift({...missing_day, class: "no-data", newCases: "no data"});
            }

            days[0].class = (days[0].class) ? `today ${days[0].class}` : 'today';

            const visual = document.createElement('p');
            days.forEach(day => {
                const dayBlock = document.createElement('span');
                dayBlock.innerHTML = '<svg width="20px" height="20px" viewBox="1 1 20 20"><rect width="18px" height="18px" /></svg>';
                dayBlock.setAttribute('title', `${day.date}, confirmed cases: ${day.newCases}`);
                if (day.newCases === 0) {
                    dayBlock.className = 'streak';
                } else if (day.newCases < 10) {
                    dayBlock.className = 'low';
                } else if (day.newCases < 20) {
                    dayBlock.className = 'mid';
                } else if (day.newCases >= 20) {
                    dayBlock.className = 'high';
                }
                if (day.class) {
                    dayBlock.className = (dayBlock.className) ? `${dayBlock.className} ${day.class}` : day.class;
                }
                visual.append(dayBlock);
            });
            return visual;
        }

        // TODO: handle HTTP errors https://coronavirus.data.gov.uk/developers-guide#get-responses
        fetch(query_url)
            .then(response => response.json())
            .then(payload => {
                document.getElementById("dataSource").href = query_url;
                document.getElementById("daysSince").innerText = `${count_days_since(payload.data)}`;
                document.getElementById("areaName").innerText = tidy_name(payload.data[0].areaName);
                document.title = `COVID: ${tidy_name(payload.data[0].areaName)}`; // for bookmarks
                const streak = find_streaks([...payload.data].reverse()).reduce(
                    // we reverse here so that if there are multiple matches we get the most recent
                    (prev, curr) => (prev.numDays > curr.numDays) ? prev : curr, {});
                if ((!!streak.start && !streak.finish) ||
                    ((!!streak.start && !!streak.finish) && streak.numDays <= count_days_since(payload.data))) {
                    streak.numDays = count_days_since(payload.data);
                    document.getElementById("streak")
                        .innerText = `this one!`;
                } else if (!!streak.start && !!streak.finish) {
                    document.getElementById("streak")
                        .innerHTML = `${streak.numDays} `
                        + `${(streak.numDays === 1) ? 'day ' : 'days '}`
                        + `<span class="date-range">(${get_date_span_html(new Date(streak.start), new Date(streak.finish))})</span>`;
                } else {
                    document.getElementById("streak").innerText = "none found ðŸ˜¢";
                }
                document.getElementById("visualisation").insertAdjacentElement(
                    'beforeend', get_history_visual(payload.data)
                );
            });
    </script>
    <link rel="stylesheet" href="main.css"/>
</head>
<body>
<noscript>
    <p>
        This page uses Javascript to pull stats from the gov.uk COVID-19 API.
    </p>
</noscript>
<div class="stats">
    <h1 id="areaName"><em>[area name]</em></h1>
    <p class="current-streak">
        Days since last confirmed case: <span id="daysSince"><em>searchingâ€¦</em></span>
    </p>
    <p class="previous-streak">
        Best streak so far: <span id="streak"><em>searchingâ€¦</em></span>
    </p>
    <p class="data-source">
        Data source: <a id="dataSource" href="https://coronavirus.data.gov.uk">api.coronavirus.data.gov.uk</a>
        (metric: <code>newCasesBySpecimenDate</code>,
        <a href="https://coronavirus.data.gov.uk/about-data#daily-and-cumulative-numbers-of-cases">see docs</a>)
    </p>
    <div id="visualisation"></div>
    <p class="nav">&#171; <a href="index.html">All areas</a></p>
</div>
</body>
</html>